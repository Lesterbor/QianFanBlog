name: Deploy QianFanBlog
on:
  push:
    branches: [ main ]  # 只在推送到main分支时触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH Deploy and Build
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # 进入项目目录
            cd /var/www/QianFanBlog || exit 1
            
            # 更新代码
            echo "🔄 更新代码..."
            git fetch origin main
            git checkout main
            git reset --hard origin/main
            
            # 安装依赖并构建
            echo "🔧 安装依赖..."
            npm install
            
            echo "🏗️ 构建项目..."
            npm run build
            
            # 复制构建文件到Web服务器目录
            echo "🚀 部署到Web目录..."
            rm -rf /var/www/html/*
            cp -a dist/* /var/www/html/
            
            # 重启Nginx (如果需要)
            echo "🔄 重启Nginx..."
            sudo systemctl restart nginx
            
            echo "✅ 部署成功！"