name: Deploy QianFanBlog
on: [push]
jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: å…‹éš†ä»“åº“å¹¶æ„å»ºé¡¹ç›®
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: root
          password: ${{ secrets.PASSWORD }}  # æˆ–æ”¹ç”¨ key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # 1. è¿›å…¥ç›®æ ‡ç›®å½•
            cd /var/www || mkdir -p /var/www && cd /var/www
            
            # 2. å…‹éš†ä»“åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰æˆ–æ‹‰å–æœ€æ–°ä»£ç 
            if [ -d "QianFanBlog" ]; then
              echo "ğŸ”„ ä»“åº“å·²å­˜åœ¨ï¼Œæ‹‰å–æœ€æ–°ä»£ç ..."
              cd QianFanBlog
              git pull origin main  # æˆ–ä½ çš„åˆ†æ”¯åï¼ˆå¦‚ masterï¼‰
            else
              echo "ğŸ“¥ å…‹éš†ä»“åº“..."
              git clone https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_TOKEN }}@github.com/ä½ çš„ç”¨æˆ·å/QianFanBlog.git
              cd QianFanBlog
            fi

            # 3. å®‰è£…ä¾èµ–å¹¶æ„å»º
            echo "ğŸ”§ å®‰è£… npm ä¾èµ–..."
            npm install --production  # å¦‚æœåªéœ€è¦ç”Ÿäº§ä¾èµ–
            
            echo "ğŸ—ï¸ æ„å»ºé¡¹ç›®..."
            npm run build

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"